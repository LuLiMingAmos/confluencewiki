AJS.$.ajaxSetup({timeout:30000});(function(h){h(function(){x()&&h("h1").append("<small style='display: block'> dev mode active: running against lasso/hamlet staging servers. feel free to create accounts and generate keys with fake data</small>")});function a(z){function B(D){var C=D?D.toLowerCase():"";if(C=="true"){return true}if(C=="false"){return false}return D}var y=h("meta[name='ajs-"+z+"']");var A=y.attr("content");return B(A)}var c=_.once(function(){return"withCredentials" in new XMLHttpRequest()});function x(){return a("dev-mode")}function o(){return x()?"https://id.stg.iam.atlassian.com/":"https://id.atlassian.com/"}function n(){return x()?"https://hamlet.stg.intsys.atlassian.com/":"https://hamlet.atlassian.com/"}var e=function(y){return unescape(encodeURIComponent(y))};var m=function(D){var C="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";var E=e(JSON.stringify(D))+"  ";var y=[];for(var B=0;B+2<E.length;B+=3){var F=0;for(var A=0;A<3;++A){F=(F<<8)+E.charCodeAt(B+A)}for(var A=3;A>=0;--A){var z=(F>>(6*A))&63;y.push(C.charAt(z))}}return y.join("")};var u=function(z){var A={};var y=z.serializeArray();AJS.$.each(y,function(){if(A[this.name]!==undefined){if(!A[this.name].push){A[this.name]=[A[this.name]]}A[this.name].push(this.value||"")}else{A[this.name]=this.value||""}});return A};function q(z){var y=_.pick(z,"username","password");if(c()){return AJS.$.ajax({url:o()+"id/rest/login",type:"POST",contentType:"application/json",dataType:"json",xhrFields:{withCredentials:true},data:JSON.stringify(y)})}else{return AJS.$.ajax({url:o()+"id/rest/login",type:"POST",contentType:"application/json",dataType:"jsonp",jsonp:"jsonp",data:{method:"POST","h-Content-Type":"application/json",body:m(y)}}).pipe(function(B,C){var A={};A.status=B[0].status||B.status;A.message=B[0].message||B.message;A.responseText=JSON.stringify(B[1])||"";if(A.status!=200){return(jQuery.Deferred().rejectWith(B,[A,C]))}else{A.username=B[1].username;A.xsrfToken=B[1].xsrfToken;return(jQuery.Deferred().resolveWith(B,[A,C]))}})}}function d(y){if(_.has(y,"subscribeNewsletter")){y.subscribeNewsletter="true"}if(c()){return AJS.$.ajax({url:o()+"profile/rest/signUp",type:"POST",contentType:"application/json",dataType:"json",xhrFields:{withCredentials:true},data:JSON.stringify(y)})}else{return AJS.$.ajax({url:o()+"profile/rest/signUp",type:"GET",contentType:"application/json",dataType:"jsonp",jsonp:"jsonp",data:{method:"POST","h-Content-Type":"application/json",body:m(y)}}).pipe(function(A,B){var z={};z.status=A[0].status||A.status;z.message=A[0].message||A.message;z.responseText=JSON.stringify(A[1])||"";if(z.status!=200){return(jQuery.Deferred().rejectWith(A,[z,B]))}else{z.username=A[1].username;z.xsrfToken=A[1].xsrfToken;return(jQuery.Deferred().resolveWith(A,[z,B]))}})}}function s(y,A){if(y.status===403){var z=JSON.parse(y.responseText);if(!_.isUndefined(z)){k(AJS.I18n.getText("setup.evallicense.loginmac.error.signin"),z.error)}else{k(AJS.I18n.getText("setup.evallicense.error.unknown.title"),AJS.I18n.getText("setup.evallicense.error.unknown.desc"))}}else{v(y,A)}}function l(z,B){if(z.status===400){var A=JSON.parse(z.responseText);var y=A.fieldErrors;if(y&&!h.isEmptyObject(y)){_.each(y,function(C,D){j(D,C)})}else{k(AJS.I18n.getText("setup.evallicense.error.unknown.title"),AJS.I18n.getText("setup.evallicense.error.unknown.desc"));if(A.unknownError){k(null,A.unknownError)}}}else{v(z,B)}}function v(y,z){if(y.status===500){k(AJS.I18n.getText("setup.evallicense.error.internalserver.title"),AJS.I18n.getText("setup.evallicense.error.internalserver.desc"))}else{if(y.status===404){k(AJS.I18n.getText("setup.evallicense.error.notfound.title"),AJS.I18n.getText("setup.evallicense.error.notfound.desc"))}else{if(y.status===0){k(AJS.I18n.getText("setup.evallicense.error.noconnection.title"),AJS.I18n.getText("setup.evallicense.error.noconnection.desc"))}else{if(z=="timeout"){k(AJS.I18n.getText("setup.evallicense.error.timeout.title"),AJS.I18n.getText("setup.evallicense.error.timeout.desc"))}else{k(AJS.I18n.getText("setup.evallicense.error.unknown.title"),AJS.I18n.getText("setup.evallicense.error.unknown.desc"))}}}}}function j(z,y){h("<div>").attr({id:z+"-error","class":"error"}).text(y).insertAfter(h("#"+z))}function k(A,y){var z=i();AJS.messages.error(z.find(".form-error"),{title:A,body:y,closeable:false})}function f(){AJS.$('input:[name="license-selector"]').attr("disabled","disabled")}function r(){AJS.$('input:[name="license-selector"]').removeAttr("disabled")}function w(){AJS.$(".error").remove()}function i(){return h(".license-form:visible").first()}function t(){h(":submit").removeAttr("disabled");h(".loading-spinner").remove();r()}function p(z){var y={productKey:"confluence",serverId:a("server-id")};if(c()){return AJS.$.ajax({url:n()+"1.0/public/license/createEvaluation",type:"POST",beforeSend:function(A){A.setRequestHeader("ATL-XSRF-Token",z)},xhrFields:{withCredentials:true},contentType:"application/json",dataType:"json",data:JSON.stringify(y)})}else{return AJS.$.ajax({url:n()+"1.0/public/license/createEvaluation",type:"GET",contentType:"application/json",dataType:"jsonp",jsonp:"jsonp",data:{method:"POST","h-Content-Type":"application/json","h-ATL-XSRF-Token":z,body:m(y)}}).pipe(function(B,C){var A={};A.status=B[0].status||B.status;A.message=B[0].message||B.message;A.responseText=JSON.stringify(B[1])||"";if(A.status!=200){return(jQuery.Deferred().rejectWith(B,[A,C]))}else{A.licenseKey=B[1].licenseKey;A.id=B[1].id;return(jQuery.Deferred().resolveWith(B,[A,C]))}})}}function b(y){h("#licenseString").val(y);h("#importLicenseForm").submit()}function g(B,y){var A=h("#loading-spinner-template").html();var z=_.template(A,{message:B});y.find(":submit").after(z)}h(function(){h("input[name=license-selector]").change(function(){var y=h(this).val();h(".license-form").hide();h("#"+y).show()});h("#newAccountForm").submit(function(A){A.preventDefault();w();f();g(AJS.I18n.getText("setup.evallicense.newaccount.loading"),h(this));var z=u(AJS.$(A.target));var y=d(z);y.fail(l,t);y.done(function(C){var B=p(C.xsrfToken);B.fail(v,t);B.done(function(E){var D=E.licenseKey;b(D)})})});h("#loginMacForm").submit(function(A){A.preventDefault();w();f();g(AJS.I18n.getText("setup.evallicense.loginmac.loading"),h(this));var z=u(AJS.$(A.target));var y=q(z);y.fail(s,t);y.done(function(C){var B=p(C.xsrfToken);B.fail(v,t);B.done(function(E){var D=E.licenseKey;b(D)})})});h("#importLicenseForm").submit(function(){w();f();g(AJS.I18n.getText("setup.evallicense.importlicense.loading"),h(this))})})}(AJS.$));